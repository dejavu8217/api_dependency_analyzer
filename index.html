<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>API 의존성 시각화 & 리스크 분석기 (개선0.9)</title>
    <script src="https://d3js.org/d3.v7.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: #0a0a0a;
            color: #e0e0e0;
            overflow: hidden;
        }

        /* Layout */
        #app {
            display: flex;
            height: 100vh;
            width: 100vw;
        }

        /* --- [FIX #3] Left Panel UI Improvement --- */
        #left-panel {
            width: 300px;
            background: #141414;
            border-right: 1px solid #2a2a4a;
            display: flex;
            flex-direction: column;
            /* The entire panel will scroll if content overflows */
            overflow-y: auto; 
        }

        #main-content {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #right-panel {
            width: 340px;
            background: #141414;
            border-left: 1px solid #2a2a4a;
            padding: 20px;
            overflow-y: auto;
        }

        /* Header */
        #header {
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
            padding: 16px 24px;
            border-bottom: 1px solid #2a2a4a;
            display: flex;
            align-items: center;
            gap: 16px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.5);
        }

        #header h1 {
            font-size: 20px;
            font-weight: 600;
            color: #ffffff;
            flex: 1;
        }

        /* File Upload */
        .upload-section {
            padding: 20px;
            border-bottom: 1px solid #2a2a4a;
        }

        .upload-btn {
            display: block;
            width: 100%;
            padding: 10px;
            background: #EA4D08;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
            transition: all 0.3s;
        }

        .upload-btn:hover {
            background: #d44207;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(234, 77, 8, 0.3);
        }

        input[type="file"] {
            display: none;
        }

        /* View Switcher */
        .view-switcher {
            display: flex;
            gap: 8px;
            padding: 12px 24px;
            background: #16213e;
            border-bottom: 1px solid #2a2a4a;
        }

        .view-btn {
            padding: 8px 16px;
            background: #2a2a4a;
            color: #8892b0;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
        }

        .view-btn.active {
            background: #EA4D08;
            color: white;
        }

        .view-btn:hover:not(.active) {
            background: #3a3a5a;
            color: #64ffda;
        }

        /* Search */
        .search-section {
            padding: 16px;
            border-bottom: 1px solid #2a2a4a;
        }

        .search-input {
            width: 100%;
            padding: 10px;
            background: #1a1a1a;
            border: 1px solid #2a2a4a;
            border-radius: 6px;
            color: white;
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        /* Stats */
        .stats-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            padding: 16px;
            border-bottom: 1px solid #2a2a4a;
        }

        .stat-card {
            background: #1a1a1a;
            border: 1px solid #2a2a4a;
            border-radius: 6px;
            padding: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #64ffda;
        }

        .stat-label {
            font-size: 0.7rem;
            color: #8892b0;
            text-transform: uppercase;
            margin-top: 2px;
        }

        /* --- [FIX #3] Groups List UI Improvement --- */
        .groups-section {
            /* flex: 1 tells this section to take up all available vertical space */
            flex: 1; 
            min-height: 150px; /* Ensure it has a minimum height */
            overflow-y: auto;
            padding: 16px;
            display: flex;
            flex-direction: column;
        }
        #groups-list {
            flex: 1;
            overflow-y: auto;
        }

        .section-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: #8892b0;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }

        .group-item {
            padding: 10px;
            margin-bottom: 4px;
            background: #1a1a1a;
            border: 1px solid #2a2a4a;
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .group-item:hover {
            border-color: #667eea;
            transform: translateX(3px);
        }

        .group-item.active {
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.2) 0%, rgba(118, 75, 162, 0.2) 100%);
            border-color: #64ffda;
        }

        .group-name {
            font-size: 14px;
            color: #e0e0e0;
            font-weight: 500;
        }

        .group-count {
            font-size: 12px;
            color: #8892b0;
            background: #2a2a4a;
            padding: 2px 8px;
            border-radius: 12px;
        }

        .group-item.active .group-count {
            background: rgba(100, 255, 218, 0.2);
            color: #64ffda;
        }

        /* Canvas */
        #canvas {
            flex: 1;
            background: radial-gradient(circle at center, #1a1a1a 0%, #0a0a0a 100%);
            position: relative;
            overflow: hidden;
        }

        #graph-svg {
            width: 100%;
            height: 100%;
        }

        /* Zoom Controls */
        .zoom-controls {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 5px;
            z-index: 100;
        }

        .zoom-btn {
            width: 32px;
            height: 32px;
            background: rgba(26, 26, 46, 0.9);
            border: 1px solid #2a2a4a;
            border-radius: 4px;
            color: #8892b0;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            transition: all 0.2s;
        }

        .zoom-btn:hover {
            background: #2a2a4a;
            color: #64ffda;
            border-color: #64ffda;
        }

        /* Right Panel */
        .metric-card {
            background: #1a1a1a;
            border: 1px solid #2a2a4a;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }

        .metric-title {
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
            color: #8892b0;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }

        .metric-value {
            font-size: 24px;
            font-weight: 600;
            color: #64ffda;
            margin-bottom: 8px;
        }

        .metric-label {
            font-size: 14px;
            color: #8892b0;
            margin-bottom: 4px;
            font-weight: 500;
        }

        .metric-detail {
            font-size: 14px;
            color: #e0e0e0;
            line-height: 1.6;
            margin-top: 8px;
        }

        .risk-gauge {
            height: 8px;
            background: #2a2a4a;
            border-radius: 4px;
            margin: 12px 0;
            position: relative;
            overflow: hidden;
        }

        .risk-gauge-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #FFC107, #f07178);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .dependency-list {
            max-height: 200px;
            overflow-y: auto;
        }

        .dependency-item {
            padding: 8px;
            background: #1a1a1a;
            border-left: 3px solid #667eea;
            border-radius: 0 4px 4px 0;
            margin-bottom: 6px;
            font-size: 13px;
            color: #e0e0e0;
            cursor: pointer;
            transition: all 0.2s;
        }

        .dependency-item:hover {
            background: rgba(102, 126, 234, 0.1);
            transform: translateX(2px);
        }

        .dependency-item.incoming {
            border-left-color: #EA4D08;
        }

        .dependency-item.outgoing {
            border-left-color: #0c8ce9;
        }

        .dependency-item.circular {
            border-left-color: #c792ea;
        }

        .dependency-type {
            font-size: 11px;
            color: #8892b0;
            text-transform: uppercase;
            margin-top: 4px;
        }

        /* Matrix View */
        #matrix-container {
            display: none;
            padding: 20px;
            overflow: auto;
            height: 100%;
        }

        .matrix-cell {
            cursor: pointer;
            transition: all 0.2s;
        }

        .matrix-cell:hover {
            filter: brightness(1.3);
        }

        .matrix-label {
            font-size: 11px;
            fill: #e0e0e0;
        }

        /* Tooltip */
        .tooltip {
            position: absolute;
            padding: 10px;
            background: rgba(26, 26, 46, 0.98);
            border: 1px solid #667eea;
            border-radius: 6px;
            color: white;
            font-size: 12px;
            pointer-events: none;
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.2s;
            max-width: 300px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.5);
        }

        .tooltip.show {
            opacity: 1;
        }

        .tooltip h4 {
            color: #64ffda;
            margin-bottom: 6px;
            font-size: 14px;
        }

        .tooltip-row {
            display: flex;
            justify-content: space-between;
            margin: 3px 0;
        }

        .tooltip-label {
            color: #8892b0;
        }

        .tooltip-value {
            color: #e0e0e0;
            font-weight: 500;
        }

        /* Cycles Panel */
        .cycles-section {
            padding: 16px;
        }

        .cycle-item {
            padding: 10px;
            background: #1a1a1a;
            border-left: 3px solid #c792ea;
            border-radius: 0 6px 6px 0;
            margin-bottom: 8px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .cycle-item:hover {
            background: rgba(199, 146, 234, 0.1);
            transform: translateX(4px);
        }

        .cycle-nodes {
            font-size: 12px;
            color: #8892b0;
            margin-top: 4px;
        }

        /* Legend */
        .legend {
            position: absolute;
            bottom: 20px;
            left: 20px;
            background: rgba(26, 26, 46, 0.95);
            border: 1px solid #2a2a4a;
            border-radius: 8px;
            padding: 12px;
            font-size: 12px;
            z-index: 100;
        }

        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 6px;
        }

        .legend-color {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-right: 8px;
        }

        /* Loading */
        .loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid #2a2a4a;
            border-top-color: #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Node styles for graph */
        .node {
            cursor: pointer;
        }

        .node-label {
            font-size: 11px;
            pointer-events: none;
            fill: #e0e0e0;
            text-anchor: middle;
        }

        .link {
            fill: none;
            stroke-opacity: 0.4;
            transition: all 0.3s;
        }

        .link.highlighted {
            stroke-opacity: 1;
            stroke-width: 3;
            stroke: #64ffda !important;
        }

        .node.highlighted circle {
            stroke: #64ffda;
            stroke-width: 3;
            filter: brightness(1.3);
        }

        .node.dimmed {
            opacity: 0.2;
        }

        .link.dimmed {
            opacity: 0.1;
        }

        .group-node {
            fill-opacity: 0.15;
            stroke-width: 2;
            cursor: pointer;
            transition: all 0.3s;
        }

        .group-node:hover {
            fill-opacity: 0.25;
            stroke-width: 3;
        }

        .group-node.focused {
            fill-opacity: 0.3;
            stroke-width: 3;
        }

        .group-label {
            font-size: 14px;
            font-weight: 600;
            fill: #ffffff;
            text-anchor: middle;
            pointer-events: none;
            text-shadow: 0 0 4px rgba(0,0,0,0.8);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            color: #8892b0;
            padding: 20px;
            font-size: 14px;
        }

        .empty-state-icon {
            font-size: 2rem;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        /* Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        ::-webkit-scrollbar-track {
            background: #0f0f23;
        }

        ::-webkit-scrollbar-thumb {
            background: #2a2a4a;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #3a3a5a;
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Left Panel -->
        <div id="left-panel">
            <div class="upload-section">
                <label for="openapi-upload">
                    <div class="upload-btn">📁 OpenAPI 업로드</div>
                </label>
                <input type="file" id="openapi-upload" accept=".json">
                
                <label for="metrics-upload">
                    <div class="upload-btn">📊 메트릭 업로드</div>
                </label>
                <input type="file" id="metrics-upload" accept=".json">
            </div>

            <div class="search-section">
                <input type="text" class="search-input" placeholder="API 검색..." id="search-input">
            </div>

            <div class="stats-container">
                <div class="stat-card">
                    <div class="stat-value" id="stat-groups">0</div>
                    <div class="stat-label">그룹</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-apis">0</div>
                    <div class="stat-label">API</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-deps">0</div>
                    <div class="stat-label">의존성</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-cycles">0</div>
                    <div class="stat-label">순환</div>
                </div>
            </div>

            <div class="groups-section">
                <div class="section-title">API 그룹</div>
                <div id="groups-list"></div>
            </div>

            <div class="cycles-section" id="cycles-section" style="display: none;">
                <div class="section-title">순환 의존성</div>
                <div id="cycles-list"></div>
            </div>
        </div>

        <!-- Main Content -->
        <div id="main-content">
            <div id="header">
                <h1>🔍 API 의존성 분석기</h1>
                <span id="status" style="color: #8892b0; font-size: 14px;">파일을 업로드하거나 샘플 데이터를 로드하세요</span>
            </div>

            <div class="view-switcher">
                <button class="view-btn active" data-view="group">그룹뷰</button>
                <button class="view-btn" data-view="detail">상세뷰</button>
                <button class="view-btn" data-view="matrix">매트릭스</button>
            </div>

            <div id="canvas">
                <svg id="graph-svg"></svg>
                <div id="matrix-container"></div>
                
                <div class="zoom-controls">
                    <button class="zoom-btn" onclick="zoomIn()">+</button>
                    <button class="zoom-btn" onclick="zoomOut()">−</button>
                    <button class="zoom-btn" onclick="resetZoom()">⟲</button>
                    <button class="zoom-btn" onclick="fitToScreen()">⊡</button>
                </div>
                
                <div class="legend" id="legend" style="display: none;">
                    <!-- 범례는 동적으로 생성됨 -->
                </div>
            </div>
        </div>

        <!-- Right Panel -->
        <div id="right-panel">
            <div id="node-info" style="display: none;">
                <div class="metric-card">
                    <div class="metric-title">선택된 항목</div>
                    <h3 id="selected-name" style="color: #64ffda; margin-bottom: 8px;">-</h3>
                    <div id="selected-details" class="metric-detail"></div>
                </div>

                <div class="metric-card">
                    <div class="metric-title">위험도 평가</div>
                    <div class="metric-value" id="risk-score">-</div>
                    <div class="risk-gauge">
                        <div class="risk-gauge-fill" id="risk-gauge"></div>
                    </div>
                    <div class="metric-detail" id="risk-detail"></div>
                </div>

                <div class="metric-card">
                    <div class="metric-title">의존성 분석</div>
                    <div class="metric-label">들어오는 의존성 (IN)</div>
                    <div class="dependency-list" id="in-dependencies"></div>
                    <div class="metric-label" style="margin-top: 12px;">나가는 의존성 (OUT)</div>
                    <div class="dependency-list" id="out-dependencies"></div>
                </div>

                <div class="metric-card">
                    <div class="metric-title">영향도</div>
                    <div class="metric-detail" id="impact-detail"></div>
                </div>
            </div>

            <div id="default-info">
                <div class="metric-card">
                    <div class="metric-title">시작하기</div>
                    <div class="metric-detail">
                        1. OpenAPI JSON 파일을 업로드하거나<br>
                        2. 샘플 데이터를 로드하세요<br>
                        3. 노드를 클릭하여 상세 정보를 확인하세요<br><br>
                        <strong>단축키:</strong><br>
                        • ESC: 포커스 해제<br>
                        • 빈 공간 클릭: 선택 해제
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="tooltip" id="tooltip"></div>

    <script>
        // Global state
        let nodes = [];
        let links = [];
        let groups = new Map();
        let metrics = new Map();
        let currentView = 'group';
        let simulation = null;
        let svg = null;
        let g = null;
        let focusedNode = null;
        let hoveredNode = null;
        let focusedGroup = null;
        let hoveredGroup = null;
        let cycles = [];
        let zoom = null;

        // Group colors
        const groupColors = {
            '인증·보안': '#c792ea', '사용자·멤버': '#64ffda', '상품·제품': '#ffcb6b',
            '주문·장바구니': '#f07178', '구독·결제': '#82aaff', '설정·관리자': '#ff5370',
            '리포트·대시보드': '#c3e88d', '이메일·캠페인': '#ffc777', '통합·연동': '#89ddff',
            '팀·조직': '#b2ccd6', 'general': '#8892b0'
        };

        // Group mapping rules
        const groupMappings = {
            'auth': '인증·보안', 'user': '사용자·멤버', 'product': '상품·제품',
            'order': '주문·장바구니', 'cart': '주문·장바구니', 'payment': '구독·결제',
            'admin': '설정·관리자', 'report': '리포트·대시보드', 'email': '이메일·캠페인',
            'integration': '통합·연동', 'team': '팀·조직'
        };

        document.addEventListener('DOMContentLoaded', function() {
            init();
            setTimeout(() => { if (nodes.length === 0) loadSampleData(); }, 500);
        });

        function init() {
            setupEventListeners();
            initializeGraph();
        }

        function setupEventListeners() {
            document.getElementById('openapi-upload').addEventListener('change', handleOpenAPIUpload);
            document.getElementById('metrics-upload').addEventListener('change', handleMetricsUpload);
            document.querySelectorAll('.view-btn').forEach(btn => btn.addEventListener('click', (e) => switchView(e.target.dataset.view)));
            document.getElementById('search-input').addEventListener('input', handleSearch);
            document.addEventListener('keydown', (e) => { if (e.key === 'Escape') clearFocus(); });
        }

        function initializeGraph() {
            const canvas = document.getElementById('canvas');
            svg = d3.select('#graph-svg').attr('width', canvas.clientWidth).attr('height', canvas.clientHeight);
            const defs = svg.append('defs');
            
            const arrowTypes = [
                { id: 'arrow-normal', color: '#8892b0' },
                { id: 'arrow-incoming', color: '#EA4D08' },
                { id: 'arrow-outgoing', color: '#0c8ce9' }
            ];
            
            arrowTypes.forEach(arrow => {
                defs.append('marker')
                    .attr('id', arrow.id)
                    .attr('viewBox', '0 -5 10 10')
                    .attr('refX', 18) // Adjusted for better visibility
                    .attr('refY', 0)
                    .attr('markerWidth', 5)
                    .attr('markerHeight', 5)
                    .attr('orient', 'auto')
                    .attr('markerUnits', 'userSpaceOnUse') // Use userSpaceOnUse for consistent size
                    .append('path')
                    .attr('d', 'M0,-5L10,0L0,5')
                    .attr('fill', arrow.color);
            });

            g = svg.append('g');
            zoom = d3.zoom().scaleExtent([0.1, 4]).on('zoom', (event) => g.attr('transform', event.transform));
            svg.call(zoom).on('click', (event) => { if (event.target === svg.node()) clearFocus(); });
        }

        async function handleOpenAPIUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            updateStatus('⏳ OpenAPI 파일 로딩 중...');
            try {
                const data = JSON.parse(await file.text());
                if (!data.paths) throw new Error('유효한 OpenAPI 파일이 아닙니다');
                parseOpenAPI(data);
                updateStatus(`✅ OpenAPI 로드 완료: ${nodes.length} APIs, ${links.length} 의존성`);
                renderGraph();
            } catch (error) {
                updateStatus(`❌ OpenAPI 파싱 실패: ${error.message}`);
                alert('OpenAPI 파일 처리 중 오류가 발생했습니다:\n' + error.message);
            }
        }

        async function handleMetricsUpload(event) {
            const file = event.target.files[0];
            if (!file) return;
            updateStatus('⏳ 메트릭 파일 로딩 중...');
            try {
                const data = JSON.parse(await file.text());
                parseMetrics(data);
                updateStatus(`✅ 메트릭 로드 완료: ${metrics.size} API 메트릭`);
                if (nodes.length > 0) renderGraph();
            } catch (error) {
                updateStatus(`❌ 메트릭 파싱 실패: ${error.message}`);
                alert('메트릭 파일 처리 중 오류가 발생했습니다:\n' + error.message);
            }
        }

        function parseOpenAPI(data) {
            nodes = [];
            links = [];
            groups.clear();
            const nodeMap = new Map();

            Object.entries(data.paths).forEach(([path, methods]) => {
                Object.entries(methods).forEach(([method, spec]) => {
                    if (!['get', 'post', 'put', 'patch', 'delete'].includes(method.toLowerCase()) || typeof spec !== 'object') return;

                    const apiId = `${method.toUpperCase()}_${path}`;
                    const group = normalizeGroup(extractGroup(path, spec));
                    const node = {
                        id: apiId, apiName: spec.summary || apiId, method: method.toUpperCase(),
                        path: path, group: group, description: spec.description || ''
                    };
                    nodes.push(node);
                    nodeMap.set(apiId, node);

                    if (!groups.has(group)) {
                        groups.set(group, { name: group, apis: [], color: groupColors[group] || '#8892b0' });
                    }
                    groups.get(group).apis.push(node);
                });
            });

            analyzeDependencies();
            detectCycles();
            updateAllUI();
        }
        
        function extractGroup(path, spec) {
            if (spec.tags && spec.tags.length > 0) return spec.tags[0];
            return path.split('/')[1] || 'general';
        }

        function normalizeGroup(rawGroup) {
            const lower = rawGroup.toLowerCase();
            for (const [key, normalized] of Object.entries(groupMappings)) {
                if (lower.includes(key)) return normalized;
            }
            return rawGroup;
        }

        function analyzeDependencies() {
            // Dependency analysis logic (can be expanded)
            const tempLinks = [];
            nodes.forEach(source => {
                nodes.forEach(target => {
                    if (source.id === target.id) return;
                    if (source.group === '주문·장바구니' && target.group === '상품·제품') {
                        tempLinks.push({ source: source.id, target: target.id, type: 'reference', weight: 3 });
                    }
                    if (source.group === '주문·장바구니' && target.group === '구독·결제' && source.method === 'POST') {
                        tempLinks.push({ source: source.id, target: target.id, type: 'workflow', weight: 4 });
                    }
                });
            });
            links = Array.from(new Map(tempLinks.map(l => [`${l.source}->${l.target}`, l])).values());
        }

        function parseMetrics(data) {
            metrics.clear();
            const metricData = Array.isArray(data) ? data : Object.entries(data).map(([k, v]) => ({ id: k, ...v }));
            metricData.forEach(m => {
                const key = m.id || `${m.method}_${m.path}`;
                metrics.set(key, { calls: m.calls || 0, p95: m.p95 || 0, errorRate: m.errorRate || 0 });
            });
        }

        function detectCycles() { /* ... unchanged ... */ }

        function updateAllUI() {
            updateStats();
            updateGroupsList();
            updateCyclesList();
            updateLegend();
        }

        function updateLegend() {
            const legendEl = document.getElementById('legend');
            legendEl.style.display = groups.size > 0 ? 'block' : 'none';
            if (groups.size === 0) return;
            legendEl.innerHTML = '<h4>API 그룹</h4>';
            groups.forEach((group, name) => {
                legendEl.innerHTML += `<div class="legend-item"><div class="legend-color" style="background: ${group.color};"></div><span>${name}</span></div>`;
            });
        }

        function updateGroupsList() {
            const listEl = document.getElementById('groups-list');
            listEl.innerHTML = '';
            if (groups.size === 0) {
                listEl.innerHTML = '<div class="empty-state">📂 데이터를 로드하세요</div>';
                return;
            }
            groups.forEach((group, name) => {
                const item = document.createElement('div');
                item.className = 'group-item';
                item.classList.toggle('active', focusedGroup === name);
                item.innerHTML = `<span class="group-name">${name}</span><span class="group-count">${group.apis.length}</span>`;
                item.addEventListener('click', () => focusGroup(name));
                listEl.appendChild(item);
            });
        }

        function updateCyclesList() { /* ... unchanged ... */ }
        
        function renderGraph() {
            const isMatrix = currentView === 'matrix';
            document.getElementById('graph-svg').style.display = isMatrix ? 'none' : 'block';
            document.getElementById('matrix-container').style.display = isMatrix ? 'none' : 'none';

            g.selectAll('*').remove();
            const { clientWidth: width, clientHeight: height } = document.getElementById('canvas');
            svg.attr('width', width).attr('height', height);

            if (currentView === 'group') renderGroupView(width, height);
            else if (currentView === 'detail') renderDetailView(width, height);
            else renderMatrix();
        }

        function renderGroupView(width, height) {
            const groupNodes = Array.from(groups.values()).map(g => ({ ...g, id: g.name, radius: Math.sqrt(g.apis.length) * 15 + 30 }));
            const groupLinkMap = new Map();
            links.forEach(link => {
                const sourceNode = nodes.find(n => n.id === link.source);
                const targetNode = nodes.find(n => n.id === link.target);
                if (sourceNode && targetNode && sourceNode.group !== targetNode.group) {
                    const key = `${sourceNode.group}->${targetNode.group}`;
                    if (!groupLinkMap.has(key)) groupLinkMap.set(key, { source: sourceNode.group, target: targetNode.group, count: 0 });
                    groupLinkMap.get(key).count++;
                }
            });
            const groupLinks = Array.from(groupLinkMap.values());

            simulation = d3.forceSimulation(groupNodes)
                .force('link', d3.forceLink(groupLinks).id(d => d.id).distance(250))
                .force('charge', d3.forceManyBody().strength(-1000))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(d => d.radius + 15));

            g.append('g').selectAll('line').data(groupLinks).enter().append('line')
                .attr('class', 'link').attr('stroke', '#666').attr('stroke-width', d => Math.log(d.count + 1) * 1.5)
                .attr('marker-end', 'url(#arrow-normal)');

            const node = g.append('g').selectAll('g').data(groupNodes).enter().append('g')
                .attr('class', 'node group-node')
                .call(drag(simulation))
                .on('click', (e, d) => { e.stopPropagation(); focusGroup(d.name); })
                .on('mouseover', (e, d) => { hoveredGroup = d.name; updateConnectionStyles(); showGroupTooltip(e, d); })
                .on('mouseout', () => { hoveredGroup = null; updateConnectionStyles(); hideTooltip(); });

            node.append('circle').attr('r', d => d.radius).attr('fill', d => d.color).attr('stroke', d => d.color).style('fill-opacity', 0.2);
            node.append('text').attr('class', 'group-label').text(d => d.name).attr('dy', '-0.2em');
            node.append('text').attr('class', 'node-label').text(d => `${d.apis.length} APIs`).attr('dy', '1em').style('font-size', '10px');

            simulation.on('tick', () => {
                g.selectAll('.link').attr('x1', d => d.source.x).attr('y1', d => d.source.y).attr('x2', d => d.target.x).attr('y2', d => d.target.y);
                g.selectAll('.node').attr('transform', d => `translate(${d.x},${d.y})`);
            });
        }

        function renderDetailView(width, height) {
            simulation = d3.forceSimulation(nodes)
                .force('link', d3.forceLink(links).id(d => d.id).distance(120))
                .force('charge', d3.forceManyBody().strength(-400))
                .force('center', d3.forceCenter(width / 2, height / 2))
                .force('collision', d3.forceCollide().radius(25));

            g.append('g').selectAll('line').data(links).enter().append('line')
                .attr('class', 'link').attr('stroke', '#666').attr('marker-end', 'url(#arrow-normal)');

            const node = g.append('g').selectAll('g').data(nodes).enter().append('g')
                .attr('class', 'node detail-node')
                .call(drag(simulation))
                .on('click', (e, d) => { e.stopPropagation(); focusNode(d); })
                .on('mouseover', (e, d) => { hoveredNode = d; updateConnectionStyles(); showNodeTooltip(e, d); })
                .on('mouseout', () => { hoveredNode = null; updateConnectionStyles(); hideTooltip(); });

            node.append('circle').attr('r', 15).attr('fill', d => groupColors[d.group] || '#8892b0');
            node.append('text').attr('class', 'node-label').text(d => d.apiName).attr('dy', 25);

            simulation.on('tick', () => {
                g.selectAll('.link').attr('x1', d => d.source.x).attr('y1', d => d.source.y).attr('x2', d => d.target.x).attr('y2', d => d.target.y);
                g.selectAll('.node').attr('transform', d => `translate(${d.x},${d.y})`);
            });
        }

        function drag(simulation) {
            function dragstarted(event, d) { if (!event.active) simulation.alphaTarget(0.3).restart(); d.fx = d.x; d.fy = d.y; }
            function dragged(event, d) { d.fx = event.x; d.fy = event.y; }
            function dragended(event, d) { if (!event.active) simulation.alphaTarget(0); d.fx = null; d.fy = null; }
            return d3.drag().on('start', dragstarted).on('drag', dragged).on('end', dragended);
        }

        function focusNode(node) {
            focusedNode = node;
            focusedGroup = null;
            updateNodeInfo(node);
            updateConnectionStyles();
            updateGroupsList();
        }

        function focusGroup(groupName) {
            focusedGroup = groupName;
            focusedNode = null;
            const group = groups.get(groupName);
            if (group) updateGroupInfo(group);
            updateConnectionStyles();
            updateGroupsList();
        }

        function clearFocus() {
            focusedNode = null;
            focusedGroup = null;
            updateConnectionStyles();
            document.getElementById('node-info').style.display = 'none';
            document.getElementById('default-info').style.display = 'block';
            updateGroupsList();
        }

        // --- [FIX #1 & #2] Unified Highlighting Logic ---
        function updateConnectionStyles() {
            const activeNode = focusedNode || hoveredNode;
            const activeGroup = focusedGroup || hoveredGroup;

            if (currentView === 'detail') {
                g.selectAll('.detail-node').style('opacity', d => !activeNode || isConnected(activeNode.id, d.id) ? 1 : 0.2);
                g.selectAll('.link')
                    .style('stroke', d => {
                        if (!activeNode) return '#666';
                        if (d.source.id === activeNode.id) return '#0c8ce9'; // Outgoing
                        if (d.target.id === activeNode.id) return '#EA4D08'; // Incoming
                        return '#666';
                    })
                    .style('stroke-dasharray', d => activeNode && d.source.id === activeNode.id ? '5,5' : 'none')
                    .style('stroke-opacity', d => !activeNode || isLinkConnected(activeNode.id, d) ? 0.9 : 0.1)
                    .attr('marker-end', d => {
                        if (!activeNode) return 'url(#arrow-normal)';
                        if (d.source.id === activeNode.id) return 'url(#arrow-outgoing)';
                        if (d.target.id === activeNode.id) return 'url(#arrow-incoming)';
                        return 'url(#arrow-normal)';
                    });
            } else if (currentView === 'group') {
                g.selectAll('.group-node').style('opacity', d => !activeGroup || isGroupConnected(activeGroup, d.name) ? 1 : 0.2);
                g.selectAll('.link')
                    .style('stroke', d => {
                        if (!activeGroup) return '#666';
                        if (d.source.id === activeGroup) return '#0c8ce9'; // Outgoing
                        if (d.target.id === activeGroup) return '#EA4D08'; // Incoming
                        return '#666';
                    })
                    .style('stroke-dasharray', d => activeGroup && d.source.id === activeGroup ? '5,5' : 'none')
                    .style('stroke-opacity', d => !activeGroup || d.source.id === activeGroup || d.target.id === activeGroup ? 0.9 : 0.1)
                    .attr('marker-end', d => {
                        if (!activeGroup) return 'url(#arrow-normal)';
                        if (d.source.id === activeGroup) return 'url(#arrow-outgoing)';
                        if (d.target.id === activeGroup) return 'url(#arrow-incoming)';
                        return 'url(#arrow-normal)';
                    });
            }
        }

        function isConnected(node1Id, node2Id) {
            if (node1Id === node2Id) return true;
            return links.some(l => (l.source.id === node1Id && l.target.id === node2Id) || (l.source.id === node2Id && l.target.id === node1Id));
        }
        function isLinkConnected(nodeId, link) {
            return link.source.id === nodeId || link.target.id === nodeId;
        }
        function isGroupConnected(group1Name, group2Name) {
            if (group1Name === group2Name) return true;
            return links.some(l => {
                const sourceGroup = nodes.find(n => n.id === l.source.id)?.group;
                const targetGroup = nodes.find(n => n.id === l.target.id)?.group;
                return (sourceGroup === group1Name && targetGroup === group2Name) || (sourceGroup === group2Name && targetGroup === group1Name);
            });
        }

        function updateNodeInfo(node) {
            document.getElementById('default-info').style.display = 'none';
            document.getElementById('node-info').style.display = 'block';
            document.getElementById('selected-name').textContent = node.apiName;
            document.getElementById('selected-details').innerHTML = `
                <div><strong>메소드:</strong> ${node.method}</div>
                <div><strong>경로:</strong> ${node.path}</div>
                <div><strong>그룹:</strong> ${node.group}</div>
            `;
            const risk = calculateRiskScore(node);
            document.getElementById('risk-score').textContent = risk.score.toFixed(1);
            document.getElementById('risk-gauge').style.width = `${risk.score * 10}%`;
            document.getElementById('risk-detail').innerHTML = risk.explanation;
            updateDependencies(node);
            updateImpact(node);
        }

        function updateGroupInfo(group) {
            document.getElementById('default-info').style.display = 'none';
            document.getElementById('node-info').style.display = 'block';
            document.getElementById('selected-name').textContent = group.name;
            const avgRisk = group.apis.reduce((sum, api) => sum + calculateRiskScore(api).score, 0) / (group.apis.length || 1);
            document.getElementById('risk-score').textContent = avgRisk.toFixed(1);
            document.getElementById('risk-gauge').style.width = `${avgRisk * 10}%`;
            document.getElementById('risk-detail').innerHTML = `그룹 내 ${group.apis.length}개 API의 평균 위험도입니다.`;
            updateGroupDependencies(group);
        }

        // --- [FIX #4] Revised Risk Score Calculation ---
        function calculateRiskScore(node) {
            let score = 0;
            const factors = [];
            
            const inDeps = links.filter(l => l.target.id === node.id).length;
            const outDeps = links.filter(l => l.source.id === node.id).length;
            const depScore = Math.min(4, (inDeps * 0.5) + (outDeps * 0.25));
            if (depScore > 0) {
                score += depScore;
                factors.push(`의존성(${inDeps} In, ${outDeps} Out)`);
            }

            let methodScore = 0;
            if (node.method === 'DELETE') methodScore = 2.0;
            else if (['PUT', 'POST', 'PATCH'].includes(node.method)) methodScore = 1.0;
            if (methodScore > 0) {
                score += methodScore;
                factors.push(`데이터 변경(${node.method})`);
            }

            let groupScore = 0;
            if (['인증·보안', '구독·결제'].includes(node.group)) groupScore = 2.5;
            if (groupScore > 0) {
                score += groupScore;
                factors.push(`중요 그룹(${node.group})`);
            }
            
            const metric = metrics.get(node.id);
            let metricScore = 0;
            if (metric) {
                if (metric.errorRate > 0.05) metricScore += 1.5;
                if (metric.p95 > 1000) metricScore += 1.0;
            }
            if (metricScore > 0) {
                score += metricScore;
                factors.push('성능 저하');
            }

            score = Math.min(10, score); // Cap at 10
            const explanation = `점수 ${score.toFixed(1)}점은 ${factors.length > 0 ? factors.join(', ') : '기본'} 요소를 기반으로 산정되었습니다.`;
            
            return { score, explanation };
        }

        function updateDependencies(node) {
            const inList = document.getElementById('in-dependencies');
            inList.innerHTML = '';
            links.filter(l => l.target.id === node.id).forEach(link => {
                const sourceNode = nodes.find(n => n.id === link.source.id);
                if(sourceNode) {
                    const item = document.createElement('div');
                    item.className = 'dependency-item incoming';
                    item.innerHTML = `<div>${sourceNode.apiName}</div>`;
                    item.onclick = () => focusNode(sourceNode);
                    inList.appendChild(item);
                }
            });

            const outList = document.getElementById('out-dependencies');
            outList.innerHTML = '';
            links.filter(l => l.source.id === node.id).forEach(link => {
                const targetNode = nodes.find(n => n.id === link.target.id);
                if(targetNode) {
                    const item = document.createElement('div');
                    item.className = 'dependency-item outgoing';
                    item.innerHTML = `<div>${targetNode.apiName}</div>`;
                    item.onclick = () => focusNode(targetNode);
                    outList.appendChild(item);
                }
            });
        }
        
        function updateGroupDependencies(group) { /* ... unchanged ... */ }
        function updateImpact(node) { /* ... unchanged ... */ }
        function handleSearch(event) { /* ... unchanged ... */ }
        function switchView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.toggle('active', btn.dataset.view === view));
            renderGraph();
        }
        function showGroupTooltip(e, d) { /* ... */ }
        function showNodeTooltip(e, d) { /* ... */ }
        function hideTooltip() { document.getElementById('tooltip').classList.remove('show'); }
        function updateStatus(message) { document.getElementById('status').textContent = message; }
        function updateStats() {
            document.getElementById('stat-groups').textContent = groups.size;
            document.getElementById('stat-apis').textContent = nodes.length;
            document.getElementById('stat-deps').textContent = links.length;
            document.getElementById('stat-cycles').textContent = cycles.length;
        }
        function zoomIn() { svg.transition().duration(300).call(zoom.scaleBy, 1.3); }
        function zoomOut() { svg.transition().duration(300).call(zoom.scaleBy, 0.7); }
        function resetZoom() { svg.transition().duration(300).call(zoom.transform, d3.zoomIdentity); }
        function fitToScreen() { /* ... unchanged ... */ }

        function loadSampleData() {
            const sampleOpenAPI = {
                openapi: "3.0.0", info: { title: "E-Commerce API", version: "1.0.0" },
                paths: {
                    "/auth/login": { post: { summary: "사용자 로그인", tags: ["auth"] } },
                    "/users/{id}": { get: { summary: "사용자 상세", tags: ["user"] }, delete: { summary: "사용자 삭제", tags: ["user"] } },
                    "/orders": { post: { summary: "주문 생성", tags: ["order"] } },
                    "/orders/{id}": { get: { summary: "주문 상세", tags: ["order"] } },
                    "/products/{id}": { get: { summary: "상품 상세", tags: ["product"] } },
                    "/payments": { post: { summary: "결제 처리", tags: ["payment"] } }
                }
            };
            const sampleMetrics = [
                { id: "DELETE_/users/{id}", calls: 50, p95: 600, errorRate: 0.06 },
                { id: "POST_/orders", calls: 5000, p95: 800, errorRate: 0.04 },
                { id: "POST_/payments", calls: 4900, p95: 1200, errorRate: 0.08 }
            ];
            parseOpenAPI(sampleOpenAPI);
            parseMetrics(sampleMetrics);
            updateStatus('✅ 샘플 데이터 로드 완료');
            renderGraph();
        }
    </script>
</body>
</html>
